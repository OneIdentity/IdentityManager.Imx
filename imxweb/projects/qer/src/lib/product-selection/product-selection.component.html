<div class="imx-top-container">
  <h1 class="mat-headline">
    <span translate>#LDS#Heading New Request</span>
    <span *ngIf="referenceUser || uidPersonPeerGroup"> -
      {{ ( referenceUser ? '#LDS#Heading By Reference User' : '#LDS#Heading By Peer Group' ) | translate }}
    </span>
  </h1>

  <mat-card class="imx-history" *ngIf="!referenceUser && !uidPersonPeerGroup">
    <mat-card-header>
      <eui-icon icon="time" mat-card-avatar></eui-icon>
      <mat-card-title class="mat-body-2">{{'#LDS#Heading Your Request History' | translate}}</mat-card-title>
    </mat-card-header>
    <mat-card-content>
      {{'#LDS#View the history of your requests and the current status of pending requests.' | translate}}
    </mat-card-content>
    <mat-card-actions>
      <button mat-button color="primary" (click)="goToHistory()">{{'#LDS#View' | translate}}</button>
    </mat-card-actions>
  </mat-card>

  <eui-alert *ngIf="referenceUser || uidPersonPeerGroup" class="imx-helper-alert" type="info" [condensed]="true"
    [colored]="true">
    <div class="imx-flex-alert">
      <div>
        <span>
          <ng-container *ngIf="referenceUser; else peer">
            <ng-container *ngIf="displayProducts; else refUserRolesText">
              {{ '#LDS#The following products are assigned to {0}.' | translate | ldsReplace:referenceUser.DisplayValue
              }}
            </ng-container>
            <ng-template #refUserRolesText>
              {{ '#LDS#{0} is a member of the following organizational structures.' | translate |
              ldsReplace:referenceUser.DisplayValue }}
            </ng-template>
          </ng-container>
          <ng-template #peer>
            <ng-container *ngIf="displayProducts; else peerGroupRolesText">
              {{ '#LDS#Other identities of the peer group of {0} requested the following products.' | translate |
              ldsReplace:recipients.Column.GetDisplayValue() }}
            </ng-container>
            <ng-template #peerGroupRolesText>
              {{ '#LDS#Other identities of the peer group of {0} are members of the following organizational
              structures.'
              |
              translate | ldsReplace:recipients.Column.GetDisplayValue() }}
            </ng-template>
          </ng-template>
        </span>
        &nbsp;
        <span *ngIf="displayProducts" translate>#LDS#Select the products you also want to request for the selected
          recipient.</span>
        <span *ngIf="!displayProducts" translate>#LDS#Select the organizational structures in which the selected
          recipient
          should also be a member.</span>
      </div>
      <button mat-button color="primary" class="imx-alert-button"
        [matTooltip]="(referenceUser ? '#LDS#Cancels the request by reference user' : '#LDS#Cancels the request by peer group') | translate"
        *ngIf="referenceUser || uidPersonPeerGroup" (click)="setReferenceUser(undefined)">{{
        '#LDS#Cancel' | translate }}</button>
    </div>
  </eui-alert>
  <div data-imx-identifier="Recipient" class="imx-recipients">
    <ng-container *ngIf="canRequestForSomebodyElse && !uidPersonPeerGroup; else recipientsReadonly">
      <h2 *ngIf="!requesterSelected()">{{ '#LDS#Please select at least one identity.' | translate }}</h2>
      <imx-cdr-editor [cdr]="cartItemRecipients" (valueChange)="onRecipientsChanged()"></imx-cdr-editor>
    </ng-container>
    <ng-template #recipientsReadonly>
      <imx-cdr-editor [cdr]="cartItemRecipientsReadonly"></imx-cdr-editor>
    </ng-template>
  </div>
  <imx-servicecategory-list class="imx-categories" *ngIf="!referenceUser && !uidPersonPeerGroup"
    [recipients]="recipients" (includeChildCategories)="onIncludeChildCategories($event)"
    data-imx-identifier="productselection-servicecategory-list" [selectedServiceCategory]="selectedCategory"
    (serviceCategorySelected)="onServiceCategorySelected($event)">
  </imx-servicecategory-list>
</div>

<!-- TODO later: a service category can be bookmarked / marked as a favorite.
      to do this, the UID of the selected category may be encoded in the URL -->

<mat-tab-group *ngIf="referenceUser || uidPersonPeerGroup; else serviceItemList"
  (selectedTabChange)="onTabChange($event)">
  <mat-tab [label]="'#LDS#Heading Products' | translate">
    <div class="imx-tab-body-content">
      <ng-container *ngTemplateOutlet="serviceItemList"></ng-container>
    </div>
  </mat-tab>
  <mat-tab [label]="'#LDS#Heading Organizational Structures' | translate">
    <div class="imx-tab-body-content">
      <imx-role-memberships [recipients]="recipientsWrapper" [referenceUser]="referenceUser"
        [personPeerGroupUid]="uidPersonPeerGroup" (selectionChanged)="onRoleSelectionChanged($event)"
        (addItemToCart)="addRoleToCart($event)" [dataSourceView]="dataSourceView">
      </imx-role-memberships>
    </div>
  </mat-tab>
</mat-tab-group>

<ng-template #serviceItemList>
  <imx-serviceitem-list data-imx-identifier="productselection-serviceitem-list" [keywords]="searchString"
    [recipients]="recipients" (selectionChanged)="onSelectionChanged($event)"
    (categoryRemoved)="onServiceCategorySelected($event)" [referenceUserUid]="referenceUser?.DataValue"
    [uidPersonPeerGroup]="uidPersonPeerGroup" [selectedServiceCategory]="selectedCategory"
    (addItemToCart)="addItemToCart($event)" [dataSourceView]="dataSourceView" (openCategoryTree)="openCategoryTree()">
  </imx-serviceitem-list>
</ng-template>

<ng-container *ngIf="requesterSelected()">
  <div data-imx-identifier="productselection-div-buttonbar" class="imx-button-bar">
    <ng-container *ngIf="displayProducts; else selectedRolesDisplay">
      <p class="imx-selected-products">
        <span data-imx-identifier="productselection-selection-count">{{ '#LDS#Selected products' | translate }}</span>
        <eui-badge class="imx-badge" color="orange">{{selectedItems?.length}}</eui-badge>
      </p>
      <button mat-stroked-button (click)="onSelectall()"
        data-imx-identifier="productselection-select-all">{{'#LDS#Select all on page' | translate}}</button>
      <button mat-stroked-button (click)="onDeselectAll()" data-imx-identifier="productselection-deselect-all"
        [disabled]="selectedItems?.length === 0">{{'#LDS#Deselect all' | translate}}</button>
    </ng-container>
    <ng-template #selectedRolesDisplay>
      <p class="imx-selected-products">
        <span data-imx-identifier="productselection-roles-selection-count">{{'#LDS#Selected organizational structures' |
          translate}} </span>
        <eui-badge class="imx-badge" color="orange">{{ selectedRoles?.length }}</eui-badge>
      </p>
      <button mat-stroked-button (click)="selectAllRolesOnPage()"
        data-imx-identifier="productselection-roles-select-all">{{'#LDS#Select all on page' | translate}}</button>
      <button mat-stroked-button (click)="deselectAllRoles()" data-imx-identifier="productselection-roles-deselect-all"
        [disabled]="!selectedRoles?.length">{{'#LDS#Deselect all' | translate}}</button>
    </ng-template>
    <div class="imx-menu-spacer"></div>
    <button [matMenuTriggerFor]="ToolbarButton1" mat-stroked-button *ngIf="canSelectByRefUser"
      data-imx-identifier="productselection-button-actions">
      <eui-icon icon="ellipsisvertical"></eui-icon>
    </button>
    <mat-menu #ToolbarButton1="matMenu">
      <!-- 262857 hide these menu items
          <button mat-menu-item (click)="showRequestsForRecipient()">
              {{'#LDS#Check requests for this recipient' | translate}}</button>
          <button mat-menu-item (click)="selectRequestTemplate()" *ngIf="canSelectFromTemplate">
              {{'#LDS#Select a request template' | translate}}</button>
          -->
      <button mat-menu-item (click)="selectReferenceUser()" *ngIf="canSelectByRefUser">
        {{ '#LDS#Select a reference user' | translate }}
      </button>
      <button mat-menu-item (click)="setPeerGroupPerson(recipients.value)" [disabled]="uidPersonPeerGroup"
        *ngIf="canSelectByRefUser && isSinglePersonRequest()">
        {{ '#LDS#Show products other identities requested' | translate }}
      </button>
    </mat-menu>

    <button [disabled]="!selectedItems?.length && !selectedRoles?.length" mat-raised-button color="primary"
      (click)="onAddItemsToCart()" data-imx-identifier="productselection-button-add-to-cart">{{'#LDS#Add to cart' |
      translate}}</button>
  </div>
</ng-container>

<ng-template #Call4>
  <div mat-dialog-content>
    <!-- TODO later -->
    <!-- <h1 mat-dialog-title>{{accProductSelected.GetEntity().GetDisplay()}}</h1> -->

    <h2>{{ '#LDS#This product has already been assigned to {0}.' | translate |
      ldsReplace:recipients?.Column?.GetDisplayValue() }}
      {{ '#LDS#You can still submit a request for the product. Please see the details about the assignmeht below.' |
      translate}}
    </h2>
    <!-- TODO later
        <VI_Roles_EntitlementDetective [UID_Person]="recipients.value"
            [ObjectKeyEntitlement]="from accproductstatusforperson select top 1 objectkeyentitlement where uid_accproduct = (from accproductcandidate select current uid_accproduct) and uid_person = this.recipients.value and status in ('PERSONHASOBJECT','PERSONHASASSIGNMENTORDER')">
        </VI_Roles_EntitlementDetective>
        -->
  </div>
  <mat-dialog-actions align="end">
    <button mat-button mat-dialog-close>{{ '#LDS#Close' | translate }}</button>
  </mat-dialog-actions>
</ng-template>

<ng-template #CallAction12>
  <h1 mat-dialog-title>{{'#LDS#Choose a template' | translate}}</h1>
  <mat-dialog-content>
    <!-- TODO later
        <imx-itshop-patternselection></imx-itshop-patternselection>
        -->
  </mat-dialog-content>
  <mat-dialog-actions align="end">
    <button mat-button mat-dialog-close>{{ '#LDS#Close' | translate }}</button>
  </mat-dialog-actions>
</ng-template>